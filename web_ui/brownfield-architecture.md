# Brownfield Architecture: Fyers Trading Platform

*This document was auto-generated by the `document-project` task to reflect the current state of the codebase.*

## 1. Project Overview

This project is a trading platform that interfaces with the Fyers API. It provides a comprehensive suite of tools for both backtesting trading strategies against historical data and simulating live paper trading. The primary user interface is a web-based dashboard built with Streamlit, which allows users to configure and run backtests, optimize strategy parameters, and view performance reports and logs.

The system is designed with a clear separation of concerns, isolating data fetching, strategy logic, portfolio management, and user interface into distinct components.

## 2. Core Components

### `src/auth`
- **Purpose**: Manages the entire Fyers API authentication flow.
- **Key Files**: `auth.py`
- **Functionality**: Handles the OAuth2 process, including generating auth codes, creating access/refresh tokens, and storing them in `fyers_tokens.json`. Provides helper functions to get an authenticated `fyersModel` instance.

### `src/data` & `src/fetch_historical_data.py`
- **Purpose**: Responsible for populating the historical market database.
- **Key Files**: `fetch_historical_data.py`, `market_calendar.py`
- **Functionality**: Fetches top NIFTY stock symbols and ATM option symbols. Connects to the Fyers API to download historical candle data for specified resolutions and stores it in the `historical_market_data.sqlite` database.

### `src/paper_trading`
- **Purpose**: Contains the core logic for managing a trading account's state.
- **Key Files**: `portfolio.py`, `oms.py` (Order Management System), `engine.py` (Live Trading Engine)
- **Functionality**:
    - `Portfolio`: Tracks cash, positions, and P&L. It is agnostic to whether it's being used in a backtest or live simulation.
    - `OrderManager`: Simulates or places real orders, updating the portfolio accordingly.
    - `LiveTradingEngine`: Connects to the Fyers WebSocket to process live ticks and pass them to a strategy.

### `src/backtesting`
- **Purpose**: Provides a high-performance, vectorized backtesting engine.
- **Key Files**: `engine.py`
- **Functionality**: Loads historical data from the database, generates all trading signals for a given strategy at once using pandas, and then simulates the trades to produce a performance report. This vectorized approach is significantly faster than event-driven (loop-based) backtesting.

### `src/strategies`
- **Purpose**: Defines the logic for making trading decisions.
- **Key Files**: `base_strategy.py`, `simple_ma_crossover.py`
- **Functionality**: Implements trading strategies. Each strategy must inherit from `BaseStrategy`. The `SMACrossoverStrategy` is the primary example, with methods for both vectorized signal generation (`generate_signals`) for backtesting and live data processing (`on_data`).

### `src/reporting`
- **Purpose**: Analyzes and presents portfolio performance.
- **Key Files**: `performance_analyzer.py`
- **Functionality**: Calculates key metrics like P&L, Sharpe Ratio, Max Drawdown, and Win Rate from a completed backtest or live session.

### `web_ui`
- **Purpose**: The main user interface for the application.
- **Key Files**: `dashboard.py`
- **Functionality**: A Streamlit application that allows users to configure and run single backtests or multi-parameter optimizations. It visualizes results with interactive charts and tables and displays logs from the trading database.

## 3. Data Architecture & Flow

The application uses three separate SQLite databases to maintain a clean separation of data.

- **`data/historical_market_data.sqlite`**:
  - **Purpose**: Stores historical candle data.
  - **Populated By**: `src/fetch_historical_data.py`
  - **Read By**: `src/backtesting/engine.py` and `web_ui/dashboard.py`.

- **`data/live_market_data.sqlite`**:
  - **Purpose**: Stores live tick data captured during a live trading session.
  - **Populated By**: `src/paper_trading/engine.py` (LiveTradingEngine)
  - **Read By**: Potentially future analysis scripts.

- **`data/trading_log.sqlite`**:
  - **Purpose**: Stores the results of trading activity.
  - **Tables**: `paper_trades` (individual trade log) and `portfolio_log` (portfolio value over time).
  - **Populated By**: `src/paper_trading/oms.py` and `src/paper_trading/portfolio.py`.
  - **Read By**: `web_ui/dashboard.py` to display live logs.

## 4. Configuration Management

- **`.env` file**: Stores all secrets and environment-specific variables (API keys, credentials, etc.). This file is NOT committed to version control.
- **`config.py`**: Loads variables from the `.env` file and exposes them to the application. It also defines key file paths, ensuring consistency across the project.

## 5. Key Entry Points & Usage

1.  **Initialize the Database Schema**:
    ```bash
    python src/db_setup.py
    ```

2.  **Generate API Tokens (One-time manual step)**:
    ```bash
    python src/auth.py
    ```
    *(Follow the on-screen instructions to log in via browser and paste the redirected URL).*

3.  **Fetch Historical Data**:
    ```bash
    python src/fetch_historical_data.py
    ```

4.  **Run the Dashboard**:
    ```bash
    streamlit run web_ui/dashboard.py
    ```

5.  **Run Live Trading (Optional)**:
    ```bash
    python src/tick_collector.py
    ```

## 6. Identified Technical Debt & Risks

- **SQL Injection (Mitigated)**: Initial versions of the code used f-strings to build SQL queries. This has been refactored to use parameterized queries, significantly improving security.
- **Hardcoded Holidays**: The `src/market_calendar.py` file contains a hardcoded list of holidays for 2025. This will need to be updated annually or replaced with a dynamic holiday calendar API.
- **Live Order Execution**: The live order placement in `oms.py` assumes the order is filled at the signal price. A production-grade system would need to poll for the actual fill price and handle partial fills.
- **Error Handling**: While improving, some parts of the application could benefit from more specific error handling and user-friendly feedback, especially around API interactions.

## 7. Project Source Tree

```
fyers/
├── .bmad-core/
├── .claude/
├── .env
├── .gitignore
├── Plan.md
├── README.md
├── config.py
├── config.yaml
├── data/
│   ├── historical_market_data.sqlite
│   ├── live_market_data.sqlite
│   └── trading_log.sqlite
├── docs/
│   └── brownfield-architecture.md
├── fyers_tokens.json
├── logs/
├── requirements.txt
├── src/
│   ├── __init__.py
│   ├── auth.py
│   ├── backtesting/
│   ├── db_setup.py
│   ├── fetch_historical_data.py
│   ├── market_calendar.py
│   ├── paper_trading/
│   ├── reporting/
│   ├── strategies/
│   └── tick_collector.py
├── tests/
│   ├── paper_trading/
│   └── strategies/
└── web_ui/
    └── dashboard.py
```